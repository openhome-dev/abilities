name: Community PR Path Check

on:
  pull_request:
    branches: [dev, main]

jobs:
  path-check:
    name: path-check
    runs-on: ubuntu-latest
    if: >
      github.event.pull_request.author_association != 'MEMBER' &&
      github.event.pull_request.author_association != 'OWNER'
    steps:
      - name: Block PRs targeting main
        if: github.base_ref == 'main'
        run: |
          echo "üö´ Community PRs must target 'dev', not 'main'."
          echo "   Please close this PR and re-open against 'dev'."
          exit 1

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check community PR only touches allowed paths
        run: |
          echo "üîç Checking files changed in this PR..."
          
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "‚úÖ No files changed."
            exit 0
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          VIOLATION=false
          
          while IFS= read -r file; do
            if [[ "$file" == community/* ]]; then
              echo "‚úÖ $file (community folder ‚Äî allowed)"
              continue
            fi
            
            if [[ "$file" == "CONTRIBUTORS.md" ]]; then
              echo "‚úÖ $file (contributors list ‚Äî allowed)"
              continue
            fi
            
            if [[ "$file" == docs/* ]]; then
              echo "‚úÖ $file (docs folder ‚Äî allowed)"
              continue
            fi
            
            echo "‚ùå $file (NOT ALLOWED for community contributions)"
            VIOLATION=true
          done <<< "$CHANGED_FILES"
          
          if [ "$VIOLATION" = true ]; then
            echo ""
            echo "============================================"
            echo "üö´ BLOCKED: Community PRs can only modify:"
            echo "   ‚Ä¢ community/your-ability-name/"
            echo "   ‚Ä¢ docs/"
            echo "   ‚Ä¢ CONTRIBUTORS.md"
            echo ""
            echo "If you need to modify other files, please"
            echo "open an issue first to discuss with maintainers."
            echo "============================================"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All changed files are in allowed paths!"

  path-check-member:
    name: path-check
    runs-on: ubuntu-latest
    if: >
      github.event.pull_request.author_association == 'MEMBER' ||
      github.event.pull_request.author_association == 'OWNER' 
    steps:
      - run: echo "‚úÖ Org member ‚Äî all paths allowed"
