name: Community PR Path Check

on:
  pull_request:
    branches: [dev, main]

jobs:
  path-check:
    name: path-check
    runs-on: ubuntu-latest
    if: >
      github.event.pull_request.author_association != 'MEMBER' &&
      github.event.pull_request.author_association != 'OWNER'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check community PR only touches allowed paths
        run: |
          echo "üîç Checking files changed in this PR..."
          
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          VIOLATION=false
          
          while IFS= read -r file; do
            # Allow changes to community/ folder
            if [[ "$file" == community/* ]]; then
              echo "‚úÖ $file (community folder ‚Äî allowed)"
              continue
            fi
            
            # Allow changes to CONTRIBUTORS.md (they can add themselves)
            if [[ "$file" == "CONTRIBUTORS.md" ]]; then
              echo "‚úÖ $file (contributors list ‚Äî allowed)"
              continue
            fi
            
            # Allow changes to docs/ folder
            if [[ "$file" == docs/* ]]; then
              echo "‚úÖ $file (docs folder ‚Äî allowed)"
              continue
            fi
            
            # Everything else is a violation for community PRs
            echo "‚ùå $file (NOT ALLOWED for community contributions)"
            VIOLATION=true
          done <<< "$CHANGED_FILES"
          
          if [ "$VIOLATION" = true ]; then
            echo ""
            echo "============================================"
            echo "üö´ BLOCKED: Community PRs can only modify:"
            echo "   ‚Ä¢ community/your-ability-name/"
            echo "   ‚Ä¢ docs/"
            echo "   ‚Ä¢ CONTRIBUTORS.md"
            echo ""
            echo "If you need to modify other files, please"
            echo "open an issue first to discuss with maintainers."
            echo "============================================"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All changed files are in allowed paths!"

  # Always pass for org members (they can touch any path)
  path-check-member:
    name: path-check
    runs-on: ubuntu-latest
    if: >
      github.event.pull_request.author_association == 'MEMBER' ||
      github.event.pull_request.author_association == 'OWNER'
    steps:
      - run: echo "‚úÖ Org member ‚Äî all paths allowed"
