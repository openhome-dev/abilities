name: Lint Python (Community Abilities)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'community/**/main.py'
      - 'community/**/__init__.py'

permissions:
  contents: write
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tools
        run: pip install autopep8 autoflake flake8

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Get Changed Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get changed Python files
        id: changed
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- 'community/**/*.py' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          if [ -z "$FILES" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "found=true" >> $GITHUB_OUTPUT
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Auto-fix: Remove Unused Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Auto-fix with autoflake (remove unused imports & variables)
        if: steps.changed.outputs.found == 'true'
        run: |
          while IFS= read -r file; do
            if [ -f "$file" ] && [[ "$file" != *"__init__.py" ]]; then
              echo "ğŸ§¹ Running autoflake on $file"
              autoflake --in-place \
                --remove-all-unused-imports \
                --remove-unused-variables \
                "$file"
            fi
          done <<< "${{ steps.changed.outputs.files }}"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Auto-fix: PEP8 Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Auto-format with autopep8
        if: steps.changed.outputs.found == 'true'
        run: |
          while IFS= read -r file; do
            if [ -f "$file" ] && [[ "$file" != *"__init__.py" ]]; then
              echo "ğŸ¨ Running autopep8 on $file"
              autopep8 --in-place \
                --max-line-length=120 \
                --ignore=E501,W503 \
                "$file"
            fi
          done <<< "${{ steps.changed.outputs.files }}"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Check & Commit Changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check for formatting changes
        id: check
        run: |
          if git diff --quiet; then
            echo "has_fixes=false" >> $GITHUB_OUTPUT
          else
            echo "has_fixes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit auto-format fixes
        if: steps.check.outputs.has_fixes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add '*.py'
          git commit -m "style: auto-format with autoflake + autopep8"
          git push

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Lint Remaining Issues â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run flake8 lint check
        id: flake8
        if: steps.changed.outputs.found == 'true'
        run: |
          ERRORS=""
          while IFS= read -r file; do
            if [ -f "$file" ] && [[ "$file" != *"__init__.py" ]]; then
              RESULT=$(flake8 --max-line-length=120 --ignore=E501,W503 "$file" 2>&1 || true)
              if [ -n "$RESULT" ]; then
                ERRORS="${ERRORS}${RESULT}"$'\n'
              fi
            fi
          done <<< "${{ steps.changed.outputs.files }}"

          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo "$ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -n "$ERRORS" ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Check __init__.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check __init__.py files
        id: init_check
        if: steps.changed.outputs.found == 'true'
        run: |
          INIT_RESULTS=""
          HAS_VIOLATIONS="false"

          while IFS= read -r file; do
            if [ -f "$file" ] && [[ "$file" == *"__init__.py" ]]; then
              if [ -s "$file" ]; then
                INIT_RESULTS="${INIT_RESULTS}âŒ \`${file}\` â€” Should be empty but has content"$'\n'
                HAS_VIOLATIONS="true"
              else
                INIT_RESULTS="${INIT_RESULTS}âœ… \`${file}\` â€” Empty as expected"$'\n'
              fi
            fi
          done <<< "${{ steps.changed.outputs.files }}"

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$INIT_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "has_violations=$HAS_VIOLATIONS" >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Post PR Comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Post PR comment
        if: always() && steps.changed.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const hasAutoFixes = '${{ steps.check.outputs.has_fixes }}' === 'true';
            const errors = `${{ steps.flake8.outputs.errors }}`.trim();
            const hasErrors = '${{ steps.flake8.outputs.has_errors }}' === 'true';
            const initResults = `${{ steps.init_check.outputs.results }}`.trim();
            const hasViolations = '${{ steps.init_check.outputs.has_violations }}' === 'true';
            const files = `${{ steps.changed.outputs.files }}`.trim();

            let body = `## ğŸ” Lint Results\n\n`;

            if (hasAutoFixes) {
              body += `### ğŸ”§ Auto-formatted & Auto-fixed\n`;
              body += `Files were automatically cleaned and formatted, then committed:\n`;
              body += `- âœ… **Unused imports removed** (autoflake)\n`;
              body += `- âœ… **Unused variables removed** (autoflake)\n`;
              body += `- âœ… **PEP8 formatting applied** (autopep8)\n\n`;
            }

            if (initResults) {
              body += `### \`__init__.py\` Check\n${initResults}\n\n`;
            }

            const lintedFiles = files.split('\n').filter(f => f && !f.includes('__init__.py'));
            body += `**Files linted:** ${lintedFiles.map(f => '\`' + f + '\`').join(', ')}\n\n`;

            if (hasErrors) {
              body += `### âŒ Flake8 Errors (could not be auto-fixed)\n\`\`\`\n${errors}\n\`\`\`\n`;
              body += `Fix the remaining issues and push again. The lint will re-run automatically.\n`;
            } else if (hasViolations) {
              body += `### âš ï¸ \`__init__.py\` violations found â€” see above.\n`;
            } else {
              body += `### âœ… All checks passed! No remaining lint errors.\n`;
            }

            // Update existing bot comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('ğŸ” Lint Results'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fail the workflow if any check failed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Fail if errors
        if: |
          steps.flake8.outputs.has_errors == 'true' ||
          steps.init_check.outputs.has_violations == 'true'
        run: |
          echo "âŒ Lint failed â€” check the PR comment for details"
          exit 1
