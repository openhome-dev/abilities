name: Lint & Auto-fix

on:
  pull_request_target:
    branches: [dev, main]
    paths:
      - '**.py'

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tools
        run: pip install flake8 autopep8

      - name: Get changed Python files
        id: changed
        run: |
          git fetch origin ${{ github.base_ref }}
          ALL_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.py' \
            | grep -E '^(community|official|templates)/' || true)

          if [ -z "$ALL_FILES" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No Python files changed â€” skipping"
            exit 0
          fi

          INIT_FILES=""
          LINT_FILES=""

          while IFS= read -r file; do
            if [[ "$(basename "$file")" == "__init__.py" ]]; then
              INIT_FILES="$INIT_FILES $file"
            else
              LINT_FILES="$LINT_FILES $file"
            fi
          done <<< "$ALL_FILES"

          INIT_FILES=$(echo "$INIT_FILES" | xargs)
          LINT_FILES=$(echo "$LINT_FILES" | xargs)

          echo "skip=false" >> $GITHUB_OUTPUT
          echo "lint_files=$LINT_FILES" >> $GITHUB_OUTPUT
          echo "init_files=$INIT_FILES" >> $GITHUB_OUTPUT

          echo "ğŸ” Lint files: ${LINT_FILES:-none}"
          echo "ğŸ“¦ __init__.py files: ${INIT_FILES:-none}"

      # â”€â”€ Detect if PR is from a fork â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check if fork PR
        id: fork_check
        run: |
          if [ "${{ github.event.pull_request.head.repo.full_name }}" = "${{ github.repository }}" ]; then
            echo "is_fork=false" >> $GITHUB_OUTPUT
          else
            echo "is_fork=true" >> $GITHUB_OUTPUT
          fi

      # â”€â”€ __init__.py must be empty check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check __init__.py files are empty
        if: steps.changed.outputs.skip == 'false' && steps.changed.outputs.init_files != ''
        id: init_check
        run: |
          INIT_FILES="${{ steps.changed.outputs.init_files }}"
          > init_violations.txt
          has_violations=false

          for file in $INIT_FILES; do
            if [ ! -f "$file" ]; then
              continue
            fi

            CONTENT=$(sed '/^\s*$/d' "$file")

            if [ -n "$CONTENT" ]; then
              echo "$file" >> init_violations.txt
              has_violations=true
            fi
          done

          echo "has_violations=$has_violations" >> $GITHUB_OUTPUT

      # â”€â”€ Auto-fix with autopep8 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Auto-fix with autopep8
        if: steps.changed.outputs.skip == 'false' && steps.changed.outputs.lint_files != ''
        id: autofix
        run: |
          autopep8 --in-place --max-line-length=120 --ignore=E501,W503 \
            ${{ steps.changed.outputs.lint_files }}

          if git diff --quiet; then
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            echo "âœ… No auto-fixable issues found"
          else
            echo "has_fixes=true" >> $GITHUB_OUTPUT
            echo "ğŸ”§ Auto-fixed formatting issues:"
            git diff --stat
            git diff > autopep8_diff.txt
          fi

      # â”€â”€ Commit and push auto-fixes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit and push auto-fixes
        if: steps.autofix.outputs.has_fixes == 'true'
        id: push_fixes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "style: auto-fix flake8 formatting issues"

          if [ "${{ steps.fork_check.outputs.is_fork }}" = "true" ]; then
            echo "push_success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Cannot auto-push to fork PRs"
          else
            git push origin HEAD:refs/heads/${{ github.event.pull_request.head.ref }} && \
              echo "push_success=true" >> $GITHUB_OUTPUT || \
              echo "push_success=false" >> $GITHUB_OUTPUT
          fi

      # â”€â”€ Flake8 (remaining issues after auto-fix) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Flake8
        if: steps.changed.outputs.skip == 'false' && steps.changed.outputs.lint_files != ''
        id: flake8
        continue-on-error: true
        run: |
          OUTPUT=$(flake8 ${{ steps.changed.outputs.lint_files }} \
            --max-line-length=120 --ignore=E501,W503 2>&1) || true
          echo "$OUTPUT"
          echo "$OUTPUT" > flake8_output.txt
          if [ -n "$OUTPUT" ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      # â”€â”€ Create empty fallback files if steps were skipped â”€â”€â”€â”€â”€â”€â”€
      - name: Ensure output files exist
        if: steps.changed.outputs.skip == 'false'
        run: |
          touch flake8_output.txt init_violations.txt autopep8_diff.txt

      # â”€â”€ PR Comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment on PR
        if: always() && steps.changed.outputs.skip == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const flake8 = fs.readFileSync('flake8_output.txt', 'utf8').trim();
            const initViolations = fs.readFileSync('init_violations.txt', 'utf8').trim();
            const autopep8Diff = fs.readFileSync('autopep8_diff.txt', 'utf8').trim();

            const flake8Err = '${{ steps.flake8.outputs.has_errors }}' === 'true';
            const initErr = '${{ steps.init_check.outputs.has_violations }}' === 'true';
            const autoFixed = '${{ steps.autofix.outputs.has_fixes }}' === 'true';
            const pushOk = '${{ steps.push_fixes.outputs.push_success }}' === 'true';
            const isFork = '${{ steps.fork_check.outputs.is_fork }}' === 'true';
            const lintFiles = '${{ steps.changed.outputs.lint_files }}';
            const initFiles = '${{ steps.changed.outputs.init_files }}';

            const allPassed = !flake8Err && !initErr;

            let body = '<!-- lint-check-result -->\n';
            body += '## ğŸ” Lint Results\n\n';

            // â”€â”€ __init__.py check â”€â”€
            if (initFiles) {
              if (initErr) {
                body += '### âŒ `__init__.py` Must Be Empty\n\n';
                body += 'The following `__init__.py` files must be **completely empty** (no code, no comments, no imports):\n\n';
                body += '```\n' + initViolations + '\n```\n\n';
                body += '> `__init__.py` in ability folders is only used as a package marker. Remove all content from these files.\n\n';
              } else {
                body += '### âœ… `__init__.py` â€” Empty as expected\n\n';
              }
            }

            // â”€â”€ Auto-fix section â”€â”€
            if (autoFixed) {
              if (pushOk) {
                body += '### ğŸ”§ Auto-fixed & Pushed\n\n';
                body += 'The following formatting issues were **automatically fixed** and pushed to this branch:\n\n';
                body += '<details><summary>View auto-fix diff</summary>\n\n';
                body += '```diff\n' + autopep8Diff.slice(0, 3000) + '\n```\n\n';
                body += '</details>\n\n';
              } else {
                body += '### âš ï¸ Auto-fix Could Not Be Pushed\n\n';
                if (isFork) {
                  body += 'This PR is from a fork, so auto-fixes cannot be pushed. ';
                }
                body += 'Apply the fixes manually:\n\n';
                body += '```bash\npip install autopep8\nautopep8 --in-place --max-line-length=120 --ignore=E501,W503 <your files>\n```\n\n';
                body += '<details><summary>View suggested diff</summary>\n\n';
                body += '```diff\n' + autopep8Diff.slice(0, 3000) + '\n```\n\n';
                body += '</details>\n\n';
              }
            }

            // â”€â”€ Flake8 â”€â”€
            if (lintFiles) {
              body += `**Files linted:** \`${lintFiles}\`\n\n`;
              if (flake8Err) {
                body += '### âŒ Flake8 Errors (cannot be auto-fixed)\n\n';
                body += 'These issues require manual fixes:\n\n';
                body += '```\n' + flake8 + '\n```\n\n';
              } else {
                body += '### âœ… Flake8 â€” Passed\n\n';
              }
            } else {
              body += '_No non-init Python files to lint._\n\n';
            }

            // â”€â”€ Footer â”€â”€
            if (allPassed) {
              body += '> âœ… All checks passed!';
            } else {
              body += '> Fix the remaining issues and push again. The lint will re-run automatically.';
            }

            // â”€â”€ Upsert comment â”€â”€
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('<!-- lint-check-result -->')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # â”€â”€ Fail the workflow if any check failed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Fail if errors
        if: |
          steps.flake8.outputs.has_errors == 'true' ||
          steps.init_check.outputs.has_violations == 'true'
        run: |
          echo "âŒ Lint failed â€” check the PR comment for details"
          exit 1
