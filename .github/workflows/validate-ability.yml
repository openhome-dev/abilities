name: Validate Ability

on:
  pull_request:
    branches: [dev, main]
    paths:
      - 'community/**'
      - 'official/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-ability:
    name: validate-ability
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Find changed abilities
        id: changed
        run: |
          CHANGED_DIRS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD \
            | grep -E '^(community|official)/' \
            | cut -d'/' -f1-2 \
            | sort -u \
            | tr '\n' ' ')
          echo "dirs=$CHANGED_DIRS" >> $GITHUB_OUTPUT
          echo "Changed ability directories:"
          echo "$CHANGED_DIRS"

      - name: Run validate_ability.py
        id: validate
        continue-on-error: true
        run: |
          if [ -f "validate_ability.py" ]; then
            python validate_ability.py ${{ steps.changed.outputs.dirs }}
          fi

      - name: Comment PR with validation results
        if: always() && steps.changed.outputs.dirs != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const fs = require('fs');
            let body = '';

            // Read validation output
            try {
              const output = fs.readFileSync('validation_output.txt', 'utf8');
              const passed = '${{ steps.validate.outcome }}' === 'success';

              if (passed) {
                body = `## ‚úÖ Ability Validation Passed\n\n`;
              } else {
                body = `## ‚ùå Ability Validation Failed\n\n`;
              }

              body += `\`\`\`\n${output}\n\`\`\`\n\n`;

              if (!passed) {
                body += `### üìö How to fix\n`;
                body += `- Read the [Contributing Guide](CONTRIBUTING.md)\n`;
                body += `- Check the [CapabilityWorker Reference](docs/capability-worker.md)\n`;
                body += `- See [Blocked Imports & Keywords](https://docs.openhome.com/how_to_build_an_ability#blocked-imports-and-keywords)\n`;
              }
            } catch (e) {
              body = `## ‚ö†Ô∏è Validation script did not produce output.\n\nCheck the workflow logs.`;
            }

            // Find and update existing bot comment, or create new one
            const marker = '<!-- ability-validation-bot -->';
            body = `${marker}\n${body}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Fail if validation failed
        if: steps.validate.outcome == 'failure'
        run: exit 1
